%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Copyright 2015-2021 Finnish Geospatial Research Institute FGI, National
%% Land Survey of Finland. This file is part of FGI-GSRx software-defined
%% receiver. FGI-GSRx is a free software: you can redistribute it and/or
%% modify it under the terms of the GNU General Public License as published
%% by the Free Software Foundation, either version 3 of the License, or any
%% later version. FGI-GSRx software receiver is distributed in the hope
%% that it will be useful, but WITHOUT ANY WARRANTY, without even the
%% implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. 
%% See the GNU General Public License for more details. You should have
%% received a copy of the GNU General Public License along with FGI-GSRx
%% software-defined receiver. If not, please visit the following website 
%% for further information: https://www.gnu.org/licenses/
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function codeReplica = gpsl1cPGeneratePrnCode(PRN)
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Generates one GPS L1C pilot channel satellite code
%
% Inputs:
%   PRN         - PRN number for satellite which Weil code is generated.
%
% Outputs:
%   codeReplica - Generated code replica in chips for the given PRN number.  
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    
% Weil indices according to PRN
W = [   5111,5109,5108,5106,5103,5101,5100,5098,5095,5094,5093,5091,...
        5090,5081,5080,5069,5068,5054,5044,5027,5026,5014,5004,4980,...
        4915,4909,4893,4885,4832,4824,4591,3706,5092,4986,4965,4920,...
        4917,4858,4847,4790,4770,4318,4126,3961,3790,4911,4881,4827,...
        4795,4789,4725,4675,4539,4535,4458,4197,4096,3484,3481,3393,...
        3175,2360,1852,5065,5063,5055,5012,4981,4952,4934,4932,4786,...
        4762,4640,4601,4563,4388,3820,3687,5052,5051,5047,5039,5015,...
        5005,4984,4975,4974,4972,4962,4913,4907,4903,4833,4778,4721,...
        4661,4660,4655,4623,4590,4548,4461,4442,4347,4259,4256,4166,...
        4155,4109,4100,4023,3998,3979,3903,3568,5088,5050,5020,4990,...
        4982,4966,4949,4947,4937,4935,4906,4901,4872,4865,4863,4818,...
        4785,4781,4776,4775,4754,4696,4690,4658,4607,4599,4596,4530,...
        4524,4451,4441,4396,4340,4335,4296,4267,4168,4149,4097,4061,...
        3989,3966,3789,3775,3622,3523,3515,3492,3345,3235,3169,3157,...
        3082,3072,3032,3030,4582,4595,4068,4871,4514,4439,4122,4948,...
        4774,3923,3411,4745,4195,4897,3047,4185,4354,5077,4042,2111,...
        4311,5024,4352,4678,5034,5085,3646,4868,3668,4211,2883,2850,...
        2815,2542,2492,2376,2036,1920   ];

% Insertion indices according to PRN
P = [   412,161,1,303,207,4971,4496,5,4557,485,253,4676,1,66,4485,...
        282,193,5211,729,4848,982,5955,9805,670,464,29,429,394,616,...
        9457,4429,4771,365,9705,9489,4193,9947,824,864,347,677,6544,...
        6312,9804,278,9461,444,4839,4144,9875,197,1156,4674,10035,...
        4504,5,9937,430,5,355,909,1622,6284,9429,77,932,5973,377,...
        10000,951,6212,686,9352,5999,9912,9620,635,4951,5453,4658,...
        4800,59,318,571,565,9947,4654,148,3929,293,178,10142,9683,...
        137,565,35,5949,2,5982,825,9614,9790,5613,764,660,4870,4950,...
        4881,1151,9977,5122,10074,4832,77,4698,1002,5549,9606,9228,...
        604,4678,4854,4122,9471,5026,272,1027,317,691,509,9708,5033,...
        9938,4314,10140,4790,9823,6093,469,1215,799,756,9994,4843,...
        5271,9661,6255,5203,203,10070,30,103,5692,32,9826,76,59,...
        6831,958,1471,10070,553,5487,55,208,645,5268,1873,427,367,...
        1404,5652,5,368,451,9595,1030,1324,692,9819,4520,9911,278,...
        642,6330,5508,1872,5445,10131,422,4918,787,9864,9753,9859,...
        328,1,4733,164,135,174,132,538,176,198,595,574,321,596,491  ];

% Initialize Weil-code length to the prime that is closest to 10230
n = 10223;

% Get Weil index and insertion index according to PRN index
w = W(PRN);
p = P(PRN);

% Initialize output vector codeReplica
codeReplica = zeros(1,10230);

% Generate Legendre sequence
L = zeros(1,n);
iL = (0:n);
L(mod(iL.*iL,n)+1) = 1;
L(1) = 0;

% Compute Weil sequence
iW = (0:n-1);
W = mod(L+L(mod(iW+w,n)+1),2);

% Insert code [0,1,1,0,1,0,0] to the codeReplica at p-1
codeReplica(    1 : p-1)     = W(1:p-1);
codeReplica(    p : (p+6))   = [0,1,1,0,1,0,0];
codeReplica((p+7) : (n+7))   = W(p:n);

% Go from logical to signal representation (0 -> 1, 1 -> -1)
codeReplica = 1-2*codeReplica;